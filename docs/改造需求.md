# 关键词工具批处理改造需求

## 项目背景
当前的关键词工具Chrome扩展只能一次处理一个XLSX文件，且每批只处理20个关键词，效率较低。需要改造为支持多文件批量处理，并优化API调用效率。

## 核心需求

### 1. 多文件选择功能
- **现状**：只能单文件选择或拖拽
- **目标**：支持一次选择多个XLSX文件
- **技术方案**：使用`<input type="file" multiple>`实现多文件选择
- **用户体验**：显示选中文件列表，统一处理

### 2. API批处理优化
- **现状**：每批处理20个关键词
- **目标**：每批处理1000个关键词
- **原因**：DeepSeek API支持128K上下文，1000个词在合理范围内
- **预期效果**：大幅提升翻译效率，减少API调用次数

### 3. 文件队列处理
- **现状**：单文件处理完成后立即下载
- **目标**：依次处理所有选中文件，统一打包下载
- **处理逻辑**：
  1. 用户选择多个XLSX文件
  2. 系统依次处理每个文件
  3. 所有文件处理完成后统一提供下载

### 4. 基础错误处理
- **原则**：简单有效，不增加复杂度
- **实现**：单个文件失败不影响其他文件处理
- **错误记录**：记录失败文件名，显示处理结果摘要

## 技术实现要点

### 文件选择改造
- 修改`popup.html`中的文件输入控件
- 添加`multiple`属性支持多文件选择
- 更新UI显示选中的文件列表和数量
- 保持原有的拖拽功能

### API调用优化
- 修改`translateKeywords`方法
- 调整批处理大小从20到1000
- 优化进度显示，适应大文件处理
- 保持错误重试机制

### 文件处理流程
1. **文件选择阶段**：
   - 用户点击选择文件或拖拽多个文件
   - 显示选中文件列表和预估处理时间

2. **批量处理阶段**：
   - 依次处理每个文件
   - 实时显示当前处理文件和总体进度
   - 显示处理结果（成功/失败）

3. **结果下载阶段**：
   - 所有文件处理完成后统一打包
   - 提供批量下载按钮
   - 显示处理摘要（成功/失败统计）

### 错误处理策略
```javascript
// 基础错误处理框架
try {
    await processFile(file);
} catch (error) {
    console.error('文件处理失败:', file.name);
    // 继续处理下一个文件
}
```

## 用户体验设计

### 界面改进
- 文件选择区域支持多文件预览
- 进度显示包含总体进度和单个文件进度
- 处理结果展示包含成功/失败统计
- 保留原有的停止处理功能

### 交互流程
1. 用户打开扩展
2. 选择多个XLSX文件（或拖拽）
3. 点击开始处理
4. 实时查看处理进度
5. 处理完成后统一下载

## 风险评估

### 技术风险
- **API限制**：1000个关键词可能超出某些API的限制
  - 缓解方案：先测试，必要时调整为500个一批
- **内存占用**：大文件可能占用较多内存
  - 缓解方案：优化数据处理逻辑

### 用户体验风险
- **处理时间**：大文件处理时间可能较长
  - 缓解方案：明确的进度显示和时间预估
- **错误处理**：用户可能担心处理失败
  - 缓解方案：透明的错误显示和重试机制

## 实施原则

1. **渐进式开发**：
   - 先实现多文件选择
   - 再优化API批处理
   - 最后完善错误处理

2. **保持简单**：
   - 不实现复杂的并发处理
   - 不引入优先级管理
   - 错误处理保持最小化

3. **用户导向**：
   - 关注用户实际使用体验
   - 根据使用反馈调整功能
   - 保持操作的直观性
# 可变并发与请求单词数优化

## 项目概述

将硬编码的并发数和批次大小改为用户可配置的参数，通过统一的插件配置界面让用户自定义设置，提升工具的灵活性和适应性。

## 需求分析

### 新增配置参数
1. **翻译数量** (BATCH_SIZE)
   - 范围：15-85
   - 默认值：40（初次打开时自动填充）
   - 当前硬编码值：20

2. **并发数** (CONCURRENCY_LIMIT)
   - 范围：2-25
   - 默认值：25（初次打开时自动填充）
   - 当前硬编码值：25

### 界面改动
- 将原"API配置"改为"插件配置"
- 采用左右布局：左侧API配置，右侧处理参数配置
- 统一保存按钮，添加问号提示图标
- 输入框旁边显示范围限制（15-85，2-25）
- 超出范围时阻止保存并显示错误提示

### 最终界面设计

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  🔑 关键词工具                                          │
│                        支持多文件处理、翻译、Kdroi计算和多平台链接生成                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│  🔧 插件配置                                                                         │
│                                                                                     │
│  API地址: [_________________________]     翻译数量: [__] 15-85                        │
│                                                                                     │
│  API密钥: [_________________________]     并发数: [__] 2-25                          │
│                                                                                     │
│                                     [保存配置] [?]                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│  📤 文件上传                                                                         │
│                                                                                     │
│  📁 拖拽XLSX文件到此处或点击选择文件                                                │
│  支持批量上传多个文件                                                              │
│                                                                                     │
│  [选择文件]                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│  📊 文件列表                                                                         │
│                                                                                     │
│  [文件1.xlsx]                    [等待处理]                                          │
│  [文件2.xlsx]                    [等待处理]                                          │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│  🔄 处理进度                                                                         │
│                                                                                     │
│  ███████████████████████████████████████████████████████████████████████ 100%        │
│  处理完毕                                                                          │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│  📥 操作                                                                             │
│                                                                                     │
│  [开始处理]  [下载合并文件]  [清空列表]                                              │
│  [查看日志]  [导出日志]  [清空日志]                                                  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

**界面特点：**
- 统一的插件配置区域，简洁明了
- 左右布局：API配置在左，处理参数在右
- 输入框长度合理，避免过长的输入框
- 保存按钮旁边添加问号提示图标
- 鼠标悬停在问号上显示详细使用说明
- 输入框旁边直接显示有效范围限制

## 改动计划

### 阶段1：界面结构调整 (HTML/CSS)

#### 1.1 修改window.html布局
- [ ] 将"API配置"改为"插件配置"
- [ ] 修改为左右布局：左侧API配置，右侧处理参数
- [ ] 添加翻译数量和并发数输入框
- [ ] 添加问号提示图标和tooltip功能
- [ ] 保留单个保存按钮

#### 1.2 CSS样式调整
- [ ] 修改.config-section为左右布局
- [ ] 调整输入框宽度适配新布局
- [ ] 添加问号图标样式
- [ ] 实现tooltip样式和动画效果

### 阶段2：配置管理功能

#### 2.1 新增配置存储
- [ ] 在Chrome存储中新增配置项：
  - `batch_size`: 翻译数量
  - `concurrency_limit`: 并发数
- [ ] 实现配置的读取和保存逻辑
- [ ] 统一保存所有配置项（API + 处理参数）

#### 2.2 配置验证和默认值
- [ ] 实现输入验证逻辑：
  - batch_size: 15-85范围验证
  - concurrency_limit: 2-25范围验证
- [ ] 设置默认值处理机制（翻译数量40，并发数25）
- [ ] 超出范围时阻止保存并显示错误提示
- [ ] 实现问号图标的tooltip提示功能

### 阶段3：核心逻辑修改

#### 3.1 KeywordProcessor类修改
- [ ] 移除硬编码常量：
  - `this.BATCH_SIZE = 20;`
  - `this.CONCURRENCY_LIMIT = 25;`
- [ ] 添加配置属性：
  - `this.batchSize = 40;` (从配置读取)
  - `this.concurrencyLimit = 25;` (从配置读取)

#### 3.2 初始化逻辑修改
- [ ] 修改`loadApiConfig()`方法，同时读取处理配置
- [ ] 在`init()`方法中初始化配置值
- [ ] 实现配置变更的实时更新

#### 3.3 并发处理逻辑修改
- [ ] 修改`processBatchesForOcean()`方法：
  - 将`this.CONCURRENCY_LIMIT`改为`this.concurrencyLimit`
  - 修改批次分组逻辑
- [ ] 修改所有使用硬编码并发数的地方
- [ ] 确保批次大小使用动态值

#### 3.4 批次创建逻辑修改
- [ ] 修改`createBatchesForOcean()`方法：
  - 使用`this.batchSize`替代固定值80
  - 确保批次切割逻辑的准确性
- [ ] 修改其他使用批次大小的地方

### 阶段4：错误处理和兼容性

#### 4.1 错误处理
- [ ] 添加配置加载失败的错误处理
- [ ] 实现配置重置功能
- [ ] 添加配置变更的用户反馈

#### 4.2 向后兼容
- [ ] 确保现有用户不受影响
- [ ] 处理旧版本配置不存在的情况
- [ ] 保持现有功能的不变性

### 阶段5：用户体验优化

#### 5.1 界面交互
- [ ] 实现问号图标的tooltip提示功能
- [ ] 实现输入框的实时验证
- [ ] 添加保存成功的用户提示
- [ ] 添加保存失败时的错误提示

#### 5.2 配置管理
- [ ] 默认值自动填充机制
- [ ] 输入范围实时显示（15-85，2-25）
- [ ] 配置项标签优化（"翻译数量"替代"每次请求翻译单词数"）

## 技术实现细节

### 数据结构设计
```javascript
// 新增配置项
this.processingConfig = {
    batchSize: 40,        // 翻译数量
    concurrencyLimit: 25  // 并发数
};

// Chrome存储结构
chrome.storage.local.set({
    deepseek_api_endpoint: endpoint,
    deepseek_api_key: key,
    batch_size: batchSize,
    concurrency_limit: concurrencyLimit
});
```

### 关键修改点
1. **KeywordProcessor构造函数**：移除硬编码常量
2. **loadApiConfig()**：扩展为读取所有配置（包括处理参数）
3. **saveApiConfig()**：统一保存所有配置（API + 处理参数）
4. **processBatchesForOcean()**：使用动态并发数
5. **createBatchesForOcean()**：使用动态批次大小
6. **HTML结构**：重构为左右布局的插件配置界面

### 验证逻辑
```javascript
// 输入验证函数
function validateBatchSize(value) {
    const num = parseInt(value);
    return !isNaN(num) && num >= 15 && num <= 85;
}

function validateConcurrencyLimit(value) {
    const num = parseInt(value);
    return !isNaN(num) && num >= 2 && num <= 25;
}

// 保存时的验证
function saveConfig() {
    const batchSize = document.getElementById('batchSize').value;
    const concurrencyLimit = document.getElementById('concurrencyLimit').value;

    if (!validateBatchSize(batchSize)) {
        showError('翻译数量必须在15-85之间');
        return;
    }

    if (!validateConcurrencyLimit(concurrencyLimit)) {
        showError('并发数必须在2-25之间');
        return;
    }

    // 保存配置...
}
```

### Tooltip实现
```javascript
// 问号提示功能
function setupTooltip() {
    const helpIcon = document.getElementById('helpIcon');
    const tooltipText = '每次请求最多处理85个单词，数量太多容易导致长尾词翻译不完全，数量太少则会导致文件处理速度太慢。请根据实际情况自行填写。';

    helpIcon.addEventListener('mouseenter', (e) => {
        showTooltip(e, tooltipText);
    });

    helpIcon.addEventListener('mouseleave', hideTooltip);
}
```

## 风险评估

### 潜在风险
1. **性能风险**：批次过大可能导致API超时或失败
2. **稳定性风险**：并发数过高可能影响浏览器性能
3. **兼容性风险**：需要确保向后兼容现有配置
4. **用户体验风险**：配置不当可能导致处理失败

### 缓解措施
1. **合理的默认值**：选择经过验证的默认配置
2. **输入验证**：严格限制输入范围
3. **用户引导**：提供清晰的使用说明
4. **错误恢复**：提供配置重置功能

## 测试计划

### 单元测试
- [ ] 配置读取和保存功能测试
- [ ] 输入验证逻辑测试
- [ ] 默认值处理测试
- [ ] 错误处理测试

### 集成测试
- [ ] 完整的文件处理流程测试
- [ ] 不同配置组合的性能测试
- [ ] 边界值测试
- [ ] 向后兼容性测试

### 用户界面测试
- [ ] 布局适配性测试
- [ ] 交互体验测试
- [ ] 响应式设计测试
- [ ] 可用性测试

## 部署计划

### 版本控制
- 版本号：v5.1
- 更新类型：功能增强
- 向后兼容：完全兼容

### 发布准备
- [ ] 更新文档和版本说明
- [ ] 准备测试环境
- [ ] 制定回滚计划
- [ ] 用户通知和培训材料

## 预期效果

### 功能提升
- 用户可以根据实际情况调整处理参数
- 更好地适应不同类型的关键词文件
- 提升工具的灵活性和适用性

### 性能优化
- 针对不同场景优化处理速度
- 减少长尾词翻译失败的情况
- 提高整体处理效率

### 用户体验
- 更直观的配置界面
- 更好的用户控制权
- 更清晰的使用指导

## 后续优化方向

1. **智能推荐**：根据文件特征自动推荐配置
2. **性能监控**：实时显示不同配置的性能指标
3. **配置模板**：预设常用的配置组合
4. **历史记录**：保存用户的历史配置和效果

---

**注意**：此为技术实施计划，具体实现时需要根据实际测试情况进行调整优化。